<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body>
    <div id="react-app"></div>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script type="text/babel">
        const EmptyState = () => {
            return (
                <div className="container text-center py-3">
                    <h1>Conectando con el servidor</h1>
                    <div className="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                        <div className="progress-bar bg-success progress-bar-striped progress-bar-animated" style={{ width: "100%" }}></div>
                    </div>
                </div>
            )
        }
        const Content = ({ status }) => {
            return (
                <div className="container">
                    <div className="row">
                        <div className="col-12 col-lg-6 py-3">
                            <Actions service={status.service} status={status.status}/>
                        </div>

                        {status.code && (
                            <div className="col-12 col-lg-6 py-3">
                                <QRCode code={status.code} />
                            </div>
                        )}
                    </div>
                </div>
            )
        }
        const QRCode = ({ code }) => {
            return (
                <fieldset>
                    <legend>C칩digo QR</legend>
                    <img src={`https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(code)}&size=800x800&margin=10&ecc=H`} style={{ width: '100%' }} />
                </fieldset>
            )
        }
        const Actions = ({ service, status }) => {
            const host =  window.location.origin;
            const request = (type) => {
                fetch(`${host}/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json()).then(data => {
                    console.log(data);
                });
            }
            return (
                <fieldset>
                    <legend>Acciones</legend>
                    <div className="btn-group" role="group" aria-label="Basic example" style={{ width: '100%' }}>
                        <button type="button" className="btn btn-success" disabled={service === "Running"} onClick={() => request('startService')}>Iniciar</button>
                        <button type="button" className="btn btn-success" disabled={service === "Paused"} onClick={() => request('stopService')}>Detener</button>
                        <button type="button" className="btn btn-success" disabled={service === "Paused"} onClick={() => request('restartService')}>Reiniciar</button>
                        <button type="button" className="btn btn-success" disabled={status === "Disconnected"} onClick={() => request('disconnectAccount')}>Desconectar</button>
                    </div>
                </fieldset>

            )
        }
        const App = (props) => {
            const [wsCLient, setWsClient] = React.useState();
            const [status, setStatus] = React.useState();

            React.useEffect(() => {
                connect()
            }, []);
            const connect = () => {
                const wsUrl = window.location.origin.replace(/^http/, 'ws').replace(/^https/, 'wss')
                const ws = new WebSocket(wsUrl);
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    setStatus(data);
                };
                ws.onclose = () => {
                    setStatus(null);
                    setTimeout(() => {
                        connect();
                    }, 5000);
                };
                ws.onerror = (error) => {
                    console.log('Error en la conexi칩n WebSocket:', error);
                };
                setWsClient(ws);
            }
            return (
                <div>
                    <nav className="navbar bg-success bg-gradient text-white">
                        <div className="container-fluid">
                            <a className="navbar-brand text-white">WhatsApp API</a>
                            <div className="d-flex" role="search">
                                <span>Service: {status ? (status.service === "Running" ? '游릭': '游리') : '游댮'} WhatsApp: {status ? (status.status === 'Connected' ? '游릭': '游댮') : '游댮'}</span>
                            </div>
                        </div>
                    </nav>
                    {status ? <Content status={status} /> : <EmptyState />}

                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('react-app')); 
    </script>
</body>

</html>